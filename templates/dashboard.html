{% extends "base.html" %}
{% block content %}

<div style="background:#1e293b; padding:20px; border-radius:8px; margin-bottom:30px; display:flex; align-items:center; justify-content:space-between; border:1px solid #334155;">
    
    <div style="width:50%;">
        <h2 style="margin:0;">üìä Project Health</h2>
        <p style="color:#94a3b8; margin-top:5px;">Real-time breakdown of open issues by priority.</p>

        <ul style="color:#cbd5e1; margin-top:15px; list-style:none; padding:0;">
            <li style="margin-bottom:5px;"><span style="color:#ef4444">‚óè</span> High Priority: <strong>{{ high|default(0) }}</strong></li>
            <li style="margin-bottom:5px;"><span style="color:#eab308">‚óè</span> Medium Priority: <strong>{{ medium|default(0) }}</strong></li>
            <li style="margin-bottom:5px;"><span style="color:#22c55e">‚óè</span> Low Priority: <strong>{{ low|default(0) }}</strong></li>
        </ul>
    </div>

    <div style="width:250px; height:250px;">
        <canvas id="priorityChart"></canvas>
    </div>
</div>

<div style="display:flex; gap:20px; flex-wrap:wrap;">

    {% if current_user.role == "admin" %}
    <div class="panel" style="flex:1; min-width:300px; background:#1e293b; padding:20px; border-radius:8px; border:1px solid #334155;">
        <h4>+ Create Project</h4>
        <form method="POST" action="{{ url_for('create_project') }}">
            <input name="name" placeholder="Project name" required style="width:100%; padding:10px; margin-bottom:10px; background:#0f172a; border:1px solid #475569; color:white; border-radius:4px;">
            <input name="description" placeholder="Description (optional)" style="width:100%; padding:10px; margin-bottom:10px; background:#0f172a; border:1px solid #475569; color:white; border-radius:4px;">
            <button style="width:100%; padding:10px; background:#3b82f6; color:white; border:none; border-radius:4px; cursor:pointer;">Create Project</button>
        </form>
    </div>
    {% endif %}

    <div class="panel" style="flex:1; min-width:300px; background:#1e293b; padding:20px; border-radius:8px; border:1px solid #334155;">
        <h4>+ Report New Bug</h4>

        {% if projects %}
        <form method="POST" action="{{ url_for('create_bug') }}">
            <input name="title" placeholder="Bug title" required style="width:100%; padding:10px; margin-bottom:10px; background:#0f172a; border:1px solid #475569; color:white; border-radius:4px;">

            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <select name="priority" style="flex:1; padding:10px; background:#0f172a; border:1px solid #475569; color:white; border-radius:4px;">
                    <option value="Low">Low</option>
                    <option value="Medium">Medium</option>
                    <option value="High">High</option>
                </select>

                <select name="project_id" style="flex:1; padding:10px; background:#0f172a; border:1px solid #475569; color:white; border-radius:4px;">
                    {% for p in projects %}
                    <option value="{{ p.id }}">{{ p.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <textarea name="description" placeholder="Describe the bug..." required style="width:100%; height:80px; padding:10px; margin-bottom:10px; background:#0f172a; border:1px solid #475569; color:white; border-radius:4px;"></textarea>

            <button style="width:100%; padding:10px; background:#22c55e; color:black; font-weight:bold; border:none; border-radius:4px; cursor:pointer;">Report Bug</button>
        </form>
        {% else %}
        <div style="text-align:center; padding:20px; color:#94a3b8; border:1px dashed #475569; border-radius:4px;">
            <p>‚ö†Ô∏è No projects found.</p>
            {% if current_user.role == 'admin' %}
                <p>Please create a project first!</p>
            {% else %}
                <p>Ask an Admin to create a project.</p>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<h4 style="margin-top:30px;">Active Issues</h4>

<div style="background:#1e293b; border-radius:8px; overflow:hidden; border:1px solid #334155;">
    <table style="width:100%; border-collapse:collapse;">
        <thead>
            <tr style="background:#0f172a; text-align:left;">
                <th style="padding:15px; color:#94a3b8;">Title</th>
                <th style="padding:15px; color:#94a3b8;">Priority</th>
                <th style="padding:15px; color:#94a3b8;">Status</th>
                <th style="padding:15px; color:#94a3b8;">Actions</th>
            </tr>
        </thead>
        <tbody>
        {% for bug in bugs %}
        <tr style="border-bottom:1px solid #334155;">
            <td style="padding:15px;">
                <strong style="font-size:1.1em;">{{ bug.title }}</strong><br>
                <span style="color:#94a3b8; font-size:0.9em;">{{ bug.description }}</span>
            </td>

            <td style="padding:15px;">
                {% if bug.priority == 'High' %}
                <span style="background:#ef4444; color:white; padding:4px 10px; border-radius:20px; font-size:0.8em; font-weight:bold;">High</span>
                {% elif bug.priority == 'Medium' %}
                <span style="background:#eab308; color:black; padding:4px 10px; border-radius:20px; font-size:0.8em; font-weight:bold;">Medium</span>
                {% else %}
                <span style="background:#22c55e; color:black; padding:4px 10px; border-radius:20px; font-size:0.8em; font-weight:bold;">Low</span>
                {% endif %}
            </td>

            <td style="padding:15px;">
                {% if bug.status == 'Resolved' %}
                <span style="color:#94a3b8; text-decoration:line-through;">Resolved</span>
                {% else %}
                <span style="color:#38bdf8; font-weight:bold;">Open</span>
                {% endif %}
            </td>

            <td style="padding:15px;">
                {% if bug.status == 'Open' %}
                <a href="{{ url_for('resolve_bug', id=bug.id) }}" style="color:#38bdf8; text-decoration:none; margin-right:15px; font-weight:bold;">Resolve</a>
                {% endif %}

                {% if current_user.role == 'admin' %}
                <a href="{{ url_for('delete_bug', id=bug.id) }}" style="color:#ef4444; text-decoration:none; font-weight:bold;" onclick="return confirm('Are you sure you want to delete this bug?');">Delete</a>
                {% endif %}
            </td>
        </tr>
        {% else %}
        <tr>
            <td colspan="4" style="padding:30px; text-align:center; color:#94a3b8;">
                üéâ No bugs reported! Good job.
            </td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

<script>
const chartEl = document.getElementById("priorityChart");
if (chartEl) {
    new Chart(chartEl, {
        type: "doughnut",
        data: {
            labels: ["High", "Medium", "Low"],
            datasets: [{
                data: [
                    {{ high|default(0) }}, 
                    {{ medium|default(0) }}, 
                    {{ low|default(0) }}
                ],
                backgroundColor: ["#ef4444","#eab308","#22c55e"],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: "70%",
            plugins: { legend: { display: false } }
        }
    });
}
</script>

{% endblock %}